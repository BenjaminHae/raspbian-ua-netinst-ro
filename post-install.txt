################################################
### Make the system read-only

# We want to be able to change hostname, hosts and mtab
# Link them to /tmp, which is a tmpfs anyway
#rm /rootfs/etc/hostname
#ln -s /tmp/hostname /rootfs/etc/hostname
#rm /rootfs/etc/hosts
#ln -s /tmp/hosts /rootfs/etc/hosts
#rm /rootfs/etc/mtab
#ln -s /proc/self/mounts /rootfs/etc/mtab

# Package should've been installed by installer-config.txt, but still...
chroot /rootfs apt-get -y install unionfs-fuse

# install node.js
chroot /rootfs curl -sL https://deb.nodesource.com/setup_7.x | bash
chroot /rootfs apt-get update
chroot /rootfs apt-get -y install nodejs

# get poisontap
chroot /rootfs curl -L https://github.com/samyk/poisontap/archive/master.zip -o /root/poisontap.zip
chroot /rootfs unzip /root/poisontap.zip -d /var/opt
mv /rootfs/var/opt/poisontap-master /rootfs/var/opt/poisontap
cp /bootfs/prepare_poison.sh /rootfs/var/opt/poisontap/
chmod +x /rootfs/var/opt/poisontap/prepare_poison.sh

#configure poisontap
cp /rootfs/var/opt/poisontap/dhcpd.conf /rootfs/etc/dhcp/
echo -e "\nauto usb0\nallow-hotplug usb0\niface usb0 inet static\n\taddress 1.0.0.1\n\tnetmask 0.0.0.0" >> /rootfs/etc/network/interfaces
echo "dtoverlay=dwc2" >> /rootfs/boot/config.txt
echo -e "dwc2\ng_ether" >> /rootfs/etc/modules
sed -i '/^exit/i \
/bin/sh /var/opt/poisontap/prepare_poison.sh' /rootfs/etc/rc.local
sed -i "s#/home/pi#/var/opt#g" /rootfs/var/opt/poisontap/pi_startup.sh

# ssh keys
mkdir -p -m 700 /rootfs/root/.ssh
cp /bootfs/authorized_keys /rootfs/root/.ssh
chmod 600 /rootfs/root/.ssh/authorized_keys

# update the pi. Sadly necessaryÃ–
chroot /rootfs apt-get -y install rpi-update
chroot /rootfs BRANCH=next rpi-update

# read only
cp /bootfs/mount_unionfs /rootfs/usr/local/bin/mount_unionfs
chmod +x /rootfs/usr/local/bin/mount_unionfs

sed -i 's/^\/dev\/mmcblk\S*\s\+\/[a-z]*\s\+\S*\s\+/&ro,/' /rootfs/etc/fstab
echo "mount_unionfs /var fuse defaults 0 0" >> /rootfs/etc/fstab

mv /rootfs/var /rootfs/var_orig
mkdir /rootfs/var /rootfs/var_rw
mount --bind /rootfs/var_orig /rootfs/var
